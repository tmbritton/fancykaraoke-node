---
import Layout from '../../layouts/Layout.astro';
import Card from '../../components/Card.astro';
import { createParty } from '../../controllers/partyController';
import PubSub from '../../helpers/pubSub'
let error: Error;

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();

    // Honeypot bot protection
    const honeypot = data.get('email-shazbot');
    if (honeypot) {
      throw new Error(`Honeypot | ${honeypot}`)
    }

    // Proceed if honeypot is not tripped
    const partyName = data.get("party-name");
    const result =  await createParty(partyName as string);

    if (result?.created) {
      return Astro.redirect(`/host/${result?.slug}`)
    }

  } catch (err) {
    if (err instanceof Error) {
      console.error(err.message);
      error = err;
    }
  }
}

if (Astro.request.method === "GET") {
  PubSub.publish('createPartyFormLoad')
}

---

<Layout title="Create a party | Fancy Karaoke">
	<div class="create-party-page">
    <Card title='Create Party'>
      <form method="post" action="/host">
        <label for="party-name">Party Name</label>
        <input type="text" name="party-name" placeholder="Enter party name" id="party-name" required minlength="2" />

        <div style={{display: 'none'}}>
          <label for="shazbot">Enter your email address</label>
          <input type="text" name="email-shazbot" id="email-shazbot" />
        </div>
        <br />
        <button
          class="button"
          type="submit"
        >
          Create party!
        </button>
      </form>
    </Card>
	</div>
</Layout>

<style>
  .create-party-page {
    max-width: 600px;
    margin: 0 auto;
  }
</style>